{% extends "base.html" %}
{% load static %}
{% block content %}

<!-- ✅ Receiver header (DP + username + profile link) -->
<div class="d-flex align-items-center justify-content-between mb-2">
  <div class="d-flex align-items-center gap-2">
    {% if other_user.profile.image %}
      <img src="{{ other_user.profile.image.url }}" class="rounded-circle" width="38" height="38" style="object-fit:cover;">
    {% else %}
      <img src="{% static 'images/default.png' %}" class="rounded-circle" width="38" height="38" style="object-fit:cover;">
    {% endif %}

    <a href="{% url 'profile' other_user.username %}" class="text-decoration-none">
      <b>Chat with {{ other_user.username }}</b>
    </a>
  </div>

  <div class="text-muted small" id="typingBox" style="display:none;">
    {{ other_user.username }} is typing...
  </div>
</div>

<div class="card p-3 mb-3" id="chatBox" style="height:65vh; overflow-y:auto;">
  <div id="messagesArea"></div>
</div>

<!-- ✅ Send form (text + file) -->
<form method="POST" class="d-flex gap-2" enctype="multipart/form-data" autocomplete="off">
  {% csrf_token %}

  <label class="btn btn-outline-secondary" style="white-space:nowrap;">
    <i class="bi bi-paperclip"></i>
    <input type="file" name="attachment" id="fileInput" hidden accept="image/*,video/*">
  </label>

  <input id="msgInput" name="text" class="form-control" placeholder="Type message...">
  <button class="btn btn-primary" style="white-space:nowrap;">Send</button>
</form>

<!-- ✅ Long-press menu -->
<div class="modal fade" id="msgMenu" tabindex="-1">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header py-2">
        <b class="modal-title">Options</b>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-2">
        <a id="deleteMsgLink" class="btn btn-danger w-100 btn-sm">Delete</a>
      </div>
    </div>
  </div>
</div>

<script>
const convoId = "{{ convo.id }}";
const me = "{{ request.user.username }}";

const chatBox = document.getElementById("chatBox");
const messagesArea = document.getElementById("messagesArea");
const typingBox = document.getElementById("typingBox");
const msgInput = document.getElementById("msgInput");

let lastRenderedCount = 0;
let lastMineId = null;

// ✅ keep scroll only if user is near bottom
function isNearBottom() {
  return (chatBox.scrollHeight - chatBox.scrollTop - chatBox.clientHeight) < 120;
}
function scrollBottom() {
  chatBox.scrollTop = chatBox.scrollHeight;
}

function escapeHtml(s){
  return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

function renderMessages(list) {
  const shouldAutoScroll = isNearBottom() || list.length !== lastRenderedCount;

  let html = "";
  lastMineId = null;

  for (const m of list) {
    const isMine = (m.sender === me);
    if (isMine) lastMineId = m.id;

    html += `
      <div class="d-flex ${isMine ? "justify-content-end" : "justify-content-start"} mb-2">
        <div class="p-2 rounded ${isMine ? "bg-primary text-white" : "bg-light"}"
             style="max-width:75%;"
             data-msg-id="${m.id}"
             data-is-mine="${isMine}"
             oncontextmenu="return openMsgMenu(event, ${m.id}, ${isMine});"
             ontouchstart="startHold(event, ${m.id}, ${isMine});"
             ontouchend="endHold();">
          <div class="small ${isMine ? "text-white-50" : "text-muted"}">
            <b>${m.sender}</b> • ${m.created}
          </div>
    `;

    // shared post
    if (m.shared_post) {
      html += `
        <div class="border rounded p-2 mt-1 bg-white text-dark">
          <div class="d-flex align-items-center gap-2 mb-1">
            <b>${escapeHtml(m.shared_post.author)}</b>
          </div>
          ${m.shared_post.image ? `<img src="${m.shared_post.image}" class="img-fluid rounded mb-2" style="max-height:220px; object-fit:cover;">` : ""}
          <div>${escapeHtml(m.shared_post.content)}</div>
          <a href="/post/${m.shared_post.id}/" class="small text-decoration-none">View Post →</a>
        </div>
      `;
    }

    // attachment
    if (m.attachment) {
      if (m.attachment_type === "image") {
        html += `<img src="${m.attachment}" class="img-fluid rounded mt-2" style="max-height:260px; object-fit:cover;">`;
      } else if (m.attachment_type === "video") {
        html += `
          <video controls class="w-100 rounded mt-2" style="max-height:260px;">
            <source src="${m.attachment}">
          </video>
        `;
      } else {
        html += `<a class="d-block mt-2" href="${m.attachment}" target="_blank">Download file</a>`;
      }
    }

    // text
    if (m.text) {
      html += `<div class="mt-1">${escapeHtml(m.text)}</div>`;
    }

    // seen on last my message
    if (isMine) {
      html += `<div class="small text-end text-white-50" id="seen-${m.id}"></div>`;
    }

    html += `</div></div>`;
  }

  messagesArea.innerHTML = html;

  // ✅ seen marker (only last msg sent by me)
  if (lastMineId) {
    const lastMsg = list.find(x => x.id === lastMineId);
    const box = document.getElementById("seen-" + lastMineId);
    if (box) box.innerText = lastMsg.is_read ? "Seen ✅" : "Sent ✓";
  }

  lastRenderedCount = list.length;
  if (shouldAutoScroll) scrollBottom();
}

async function fetchMessages() {
  const res = await fetch(`/chat/api/messages/${convoId}/`);
  const data = await res.json();
  renderMessages(data.messages);
}

async function checkTyping() {
  const res = await fetch(`/chat/api/typing/${convoId}/`);
  const data = await res.json();
  typingBox.style.display = data.typing ? "block" : "none";
}

// typing set
let typingTimer = null;
msgInput.addEventListener("input", () => {
  fetch(`/chat/api/typing/${convoId}/set/`);
  clearTimeout(typingTimer);
  typingTimer = setTimeout(()=>{}, 800);
});

// ✅ Long press (mobile)
let holdTimer = null;
function startHold(e, msgId, isMine){
  holdTimer = setTimeout(()=>{
    openMsgMenu(e, msgId, isMine);
  }, 500);
}
function endHold(){
  if (holdTimer) clearTimeout(holdTimer);
}

// ✅ Open menu (only my messages delete)
function openMsgMenu(e, msgId, isMine){
  e.preventDefault();
  if (!isMine) return false;

  const link = document.getElementById("deleteMsgLink");
  link.href = `/chat/delete/${msgId}/`;

  const modal = new bootstrap.Modal(document.getElementById("msgMenu"));
  modal.show();
  return false;
}

fetchMessages();
checkTyping();
setInterval(fetchMessages, 2000);
setInterval(checkTyping, 1500);
</script>

{% endblock %}
