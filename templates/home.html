{% extends 'base.html' %}
{% load static %}

{% block content %}

<style>
  /* ‚úÖ Reels strip scrollbar/line hide */
  .reels-row{
    display:flex;
    gap:10px;
    overflow-x:auto;
    padding-bottom: 8px;
    scroll-behavior:smooth;

    scrollbar-width: none;      /* Firefox */
    -ms-overflow-style: none;   /* IE/old Edge */
  }
  .reels-row::-webkit-scrollbar{
    display:none;               /* Chrome/Safari */
    width:0;
    height:0;
  }
</style>

<div class="row justify-content-center">
  <div class="col-md-8 col-lg-6">

    <h3 class="mb-4 text-center">üì∏ Latest Posts</h3>

    {# ‚úÖ Reels section only once (top) #}
    {% if reels_posts %}
    <div class="mb-4">
      <h5 class="mb-2">üé¨ Reels</h5>

      <div class="reels-row">
        {% for r in reels_posts %}
          {# ‚úÖ Click -> reels page open, and start with this reel #}
          <a href="{% url 'reels' %}?start={{ r.id }}" class="text-decoration-none">
            <div class="card" style="min-width:180px;">
              {# ‚úÖ Preview only (no controls, no sound) #}
              <video
                src="{{ r.video.url }}"
                muted
                playsinline
                preload="metadata"
                style="height:220px; width:180px; object-fit:cover; background:#000; display:block;"
              ></video>

              <div class="p-2 small text-dark">
                <b>{{ r.author.username }}</b>
              </div>
            </div>
          </a>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    {% for post in posts %}

    <div class="card mb-4 shadow-sm">

      <!-- ‚úÖ Header -->
      <div class="card-body pb-2">
        <div class="d-flex align-items-center justify-content-between">

          <div class="d-flex align-items-center gap-2">
            <a href="{% url 'profile' post.author.username %}">
              {% if post.author.profile.image %}
                <img src="{{ post.author.profile.image.url }}" class="rounded-circle"
                     width="35" height="35" style="object-fit:cover;">
              {% else %}
                <img src="{% static 'images/default.png' %}" class="rounded-circle"
                     width="35" height="35" style="object-fit:cover;">
              {% endif %}
            </a>

            <a href="{% url 'profile' post.author.username %}" class="text-decoration-none text-dark">
              <strong>{{ post.author.username }}</strong>
            </a>
          </div>

          {# ‚úÖ Follow button only for other users #}
          {% if user.is_authenticated and post.author != user %}
            {% if post.author.id in following_ids %}
              <form method="post" action="{% url 'unfollow_user' post.author.username %}" class="m-0">
                {% csrf_token %}
                <button class="btn btn-sm btn-outline-secondary">Following</button>
              </form>
            {% else %}
              <form method="post" action="{% url 'follow_user' post.author.username %}" class="m-0">
                {% csrf_token %}
                <button class="btn btn-sm btn-primary">Follow</button>
              </form>
            {% endif %}
          {% endif %}

        </div>
      </div>

      <!-- ‚úÖ Media -->
      {% if post.video %}
        <video class="w-100" controls playsinline preload="metadata"
               style="max-height:450px; object-fit:cover; background:#000;">
          <source src="{{ post.video.url }}">
        </video>
      {% elif post.image %}
        <img src="{{ post.image.url }}" class="img-fluid"
             style="max-height:450px; object-fit:contain; background:#f8f9fa;">
      {% endif %}

      <!-- ‚úÖ Body -->
      <div class="card-body pt-2">

        <div class="d-flex flex-wrap gap-2 align-items-center mb-2">

          <!-- ‚ù§Ô∏è Like -->
          <form action="{% url 'like_post' post.id %}" method="POST" class="m-0">
            {% csrf_token %}
            {% if user in post.likes.all %}
              <button type="submit" class="btn btn-sm btn-danger">‚ù§Ô∏è {{ post.total_likes }}</button>
            {% else %}
              <button type="submit" class="btn btn-sm btn-outline-danger">ü§ç {{ post.total_likes }}</button>
            {% endif %}
          </form>

          <!-- ‚úâ Share -->
          <a href="{% url 'share_choose_user' post.id %}" class="btn btn-sm btn-outline-success">
            <i class="bi bi-send"></i>
          </a>

          <!-- üîó Copy link icon only -->
          <button class="btn btn-sm btn-outline-secondary" type="button"
                  onclick="copyPostLink('{{ request.scheme }}://{{ request.get_host }}{% url 'post_detail' post.id %}')"
                  title="Copy link">
            <i class="bi bi-link-45deg"></i>
          </button>

          <span class="ms-auto small text-muted">üîÅ {{ post.share_count }} shares</span>
        </div>

        <p class="mb-2">{{ post.content }}</p>

        <small class="text-muted d-block mb-2">
          Posted on {{ post.created|date:"F j, Y, g:i a" }}
        </small>

        <!-- üí¨ Comment form -->
        <form action="{% url 'add_comment' post.id %}" method="POST" class="mb-2">
          {% csrf_token %}
          <div class="input-group">
            <input type="text" name="comment" class="form-control form-control-sm" placeholder="Add a comment..." required>
            <button class="btn btn-primary btn-sm">Post</button>
          </div>
        </form>

        <!-- üí¨ Comments -->
        <div>
          {% for comment in post.comments.all %}
            <small class="d-block">
              <strong>
                <a href="{% url 'profile' comment.user.username %}" class="text-decoration-none">
                  {{ comment.user.username }}
                </a>
              </strong>
              : {{ comment.text }}
            </small>
          {% empty %}
            <small class="text-muted">No comments yet</small>
          {% endfor %}
        </div>

      </div>
    </div>

    {% empty %}
      <p class="text-center">No posts yet üòî</p>
    {% endfor %}

  </div>
</div>

<script>
function copyPostLink(link) {
  navigator.clipboard.writeText(link).then(() => alert("Link copied ‚úÖ"));
}

/* ‚úÖ Reels preview: hover on desktop -> play, mouse out -> pause */
document.querySelectorAll(".reels-row video").forEach(v=>{
  v.addEventListener("mouseenter", ()=> v.play().catch(()=>{}));
  v.addEventListener("mouseleave", ()=> { v.pause(); v.currentTime = 0; });
});
</script>

{% endblock %}
